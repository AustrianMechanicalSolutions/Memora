<div class="page">
  <!-- Top bar -->
  <div class="top-nav">
    <button class="link" (click)="backToAlbums()">‚Üê Back to Albums</button>
  </div>

  <!-- Album Hero -->
  <section class="hero" *ngIf="album">
    <div class="hero-card">
      <div class="hero-left">
        <div class="hero-cover">
          {{ album.title.charAt(0) }}
        </div>

        <div class="hero-meta">
          <h1>{{ album.title }}</h1>
          <div class="hero-sub">
            {{ items.length }} memories
          </div>
        </div>
      </div>

      <button class="btn primary hero-action" (click)="openAddMemory()">
        + Add Memory
      </button>
    </div>
  </section>

  <section class="album-people" *ngIf="albumId !== 'all'">
    <div class="people-header">
      <h3>People</h3>

      <button
        *ngIf="canEditAlbum"
        class="btn ghost"
        (click)="openAddPerson()">
        + Add Person
      </button>
    </div>

    <div class="people-row">
      <div class="person-card" *ngFor="let p of albumPeople">
        <div class="avatar-wrap">
          <img
            *ngIf="p.avatarUrl; else initials"
            class="avatar"
            [src]="p.avatarUrl"
          />

          <ng-template #initials>
            <div class="avatar">{{ p.name.charAt(0) }}</div>
          </ng-template>

          <!-- remove button -->
          <button
            *ngIf="canEditAlbum"
            class="remove-btn"
            (click)="removePerson(p.userId); $event.stopPropagation()">
            √ó
          </button>
        </div>

        <div class="name">{{ p.name }}</div>
      </div>
    </div>
  </section>

  <!-- Memory Wall -->
  <section class="wall-section">
    <h2 class="wall-title">Memory Wall</h2>

    <div class="wall" *ngIf="items.length > 0; else emptyState">
      <div class="wall-card" *ngFor="let m of items">
        <!-- Photo / Video -->
        <ng-container *ngIf="m.type !== 2">
          <img
            *ngIf="m.type === 0 && isImage(m.mediaUrl)"
            class="wall-media"
            [src]="'http://localhost:5000' + m.mediaUrl"
          />

          <video
            *ngIf="m.type === 1 && isVideo(m.mediaUrl)"
            class="wall-media"
            controls
            [src]="'http://localhost:5000' + m.mediaUrl"
          ></video>

          <div *ngIf="m.type === 0 && !isImage(m.mediaUrl)" class="media-error">Unsupported image file</div>
          <div *ngIf="m.type === 1 && !isVideo(m.mediaUrl)" class="media-error">Unsupported video file</div>

          <div class="wall-date">
            {{ m.happenedAt | date:'dd/MM/yyyy' }}
          </div>
        </ng-container>

        <!-- Quote -->
        <div class="quote-card" *ngIf="m.type === 2">
          <div class="quote-text">
            ‚Äú{{ m.quoteText }}‚Äù
          </div>

          <div class="quote-by" *ngIf="m.quoteBy">
            ‚Äî {{ m.quoteBy }}
          </div>

          <div class="wall-date">
            {{ m.happenedAt | date:'dd/MM/yyyy' }}
          </div>
        </div>
      </div>
    </div>

    <ng-template #emptyState>
      <div class="empty">
        <h3>No memories yet</h3>
        <p>Add your first memory to this album ‚ú®</p>
      </div>
    </ng-template>
  </section>

  <div class="modal-backdrop" *ngIf="showAddMemoryModal">
    <div class="modal">
      <button class="modal-close" (click)="showAddMemoryModal = false">√ó</button>

      <h2>Add Memory</h2>

      <!-- Choose -->
      <div *ngIf="addStep === 'choose'" class="choice-grid">
        <div class="choice-card" (click)="addStep='media'; mediaType='photo'">
          <div class="icon">üñºÔ∏è</div>
          <div class="title">Upload Photo</div>
        </div>

        <div class="choice-card" (click)="addStep='media'; mediaType='video'">
          <div class="icon">üé•</div>
          <div class="title">Upload Video</div>
        </div>

        <div class="choice-card" (click)="addStep='quote'">
          <div class="icon">‚ùù</div>
          <div class="title">Add Quote</div>
        </div>
      </div>

      <!-- Media -->
      <div *ngIf="addStep === 'media'" class="modal-body">
        <div class="form">
          <label class="upload-box">
            <input type="file" hidden (change)="onFileSelected($event)" />
            <div class="upload-icon">‚¨Ü</div>
            <div class="upload-title">
              Click to upload {{ mediaType }}
            </div>
            <div class="hint">
              {{ mediaType === 'photo' ? 'JPG, PNG, GIF' : 'MP4, MOV' }} up to 10MB
            </div>
          </label>

          <div class="media-preview" *ngIf="previewUrl">
            <img
              *ngIf="mediaType === 'photo'"
              [src]="previewUrl"
            />

            <video
              *ngIf="mediaType === 'video'"
              [src]="previewUrl"
              controls
            ></video>
          </div>

          <div class="field">
            <label>Date</label>
            <input type="date" class="input" [(ngModel)]="newDate" />
          </div>
        </div>

        <div class="modal-actions">
          <button class="btn ghost" (click)="addStep='choose'">Back</button>
          <button class="btn primary" (click)="submitMedia()">
            Add {{ mediaType | titlecase }}
          </button>
        </div>
      </div>

      <!-- Quote -->
      <div *ngIf="addStep === 'quote'" class="modal-body">
        <div class="form">
          <div class="field">
            <label>Quote Text</label>
            <textarea
              class="input textarea"
              placeholder="Write your message or quote here..."
              [(ngModel)]="newQuoteText"
            ></textarea>
          </div>

          <div class="field">
            <label>Who said it?</label>
            <div class="mention-wrap">
              <input
                class="input"
                [(ngModel)]="newQuoteBy"
                placeholder="Type a name... or @ to tag"
                (input)="onQuoteByInput()"
                (keydown)="onQuoteByKeydown($event)"
                (blur)="closeMentionPopup()"
              />

              <div class="mention-popup" *ngIf="showMentionPopup">
                <div
                  class="mention-item"
                  *ngFor="let u of mentionResults; let i = index"
                  [class.active]="i === mentionIndex"
                  (mousedown)="selectMention(u)"
                >
                  @{{ u.name }}
                  <span class="muted">({{ u.role }})</span>
                </div>
              </div>
            </div>
          </div>

          <div class="field">
            <label>Date</label>
            <input type="date" class="input" [(ngModel)]="newDate" />
          </div>
        </div>

        <div class="modal-actions">
          <button class="btn ghost" (click)="addStep='choose'">Back</button>
          <button class="btn primary" (click)="submitQuote()">Add Quote</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-backdrop" *ngIf="showAddPersonModal">
    <div class="modal">
      <button class="modal-close" (click)="closeAddPerson()">√ó</button>

      <h2>Add Person</h2>

      <div class="modal-body">
        <div class="field">
          <label>Search</label>
          <input
            class="input"
            [(ngModel)]="personQuery"
            (input)="updatePersonResults()"
            placeholder="Type a name..."
          />
        </div>

        <div class="list">
          <button
            type="button"
            class="list-item"
            *ngFor="let u of personResults"
            (click)="addPersonToAlbum(u.userId)"
          >
            <span class="avatar">
              {{ u.name.charAt(0) }}
            </span>
            <span class="name">{{ u.name }}</span>
            <span class="muted">({{ u.role }})</span>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
